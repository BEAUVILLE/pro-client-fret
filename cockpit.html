<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#061b14"/>
  <title>DIGIY FRET CLIENT PRO ‚Äî Cockpit</title>

  <script src="./guard.js"></script>

  <style>
    :root{
      --bg:#061b14; --bg2:#0a2b1f; --card:#0b2a1f; --card2:#09251b;
      --line:rgba(255,255,255,.14); --text:#eafff1; --muted:rgba(234,255,241,.72);
      --gold:#facc15; --ok:#22c55e; --bad:#fb7185; --shadow:0 18px 55px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:
        radial-gradient(circle at top, rgba(250,204,21,.10), transparent 55%),
        linear-gradient(135deg,var(--bg),var(--bg2));
      padding:16px;
    }
    .wrap{max-width:1060px;margin:0 auto}
    .top{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      background:linear-gradient(145deg,rgba(11,42,31,.96),rgba(6,35,25,.96));
      border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow);
      padding:16px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .ico{
      width:48px;height:48px;border-radius:50%;
      display:grid;place-items:center;
      background:radial-gradient(circle at 30% 0,var(--gold),transparent 60%);
      color:#062015;font-weight:1000;border:1px solid rgba(250,204,21,.35);
    }
    h1{margin:0;font-size:16px;letter-spacing:.10em}
    .sub{margin-top:5px;font-size:12px;color:var(--muted);line-height:1.4}
    .pill{
      border:1px solid var(--line); background:rgba(250,204,21,.10);
      padding:7px 10px;border-radius:999px;font-size:12px;font-weight:900;white-space:nowrap;
    }

    .grid{display:grid;gap:12px;margin-top:12px}
    @media(min-width:900px){ .grid{grid-template-columns:1.15fr .85fr} }

    .card{
      background:linear-gradient(145deg,rgba(11,42,31,.92),rgba(6,35,25,.92));
      border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow);
      padding:14px;
    }
    .title{font-weight:1000;letter-spacing:.08em;font-size:12px;color:rgba(234,255,241,.85)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      flex:1; min-width:210px;
      padding:12px 14px;border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.18); color:var(--text);
      font-weight:1000; cursor:pointer;
    }
    .btn:hover{border-color:rgba(250,204,21,.55)}
    .btn.primary{
      background:linear-gradient(90deg,var(--ok),var(--gold));
      color:#062015;border:none;
    }

    .kpis{display:grid;gap:10px;margin-top:10px}
    @media(min-width:520px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
    }
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:1000;margin-top:6px}
    .kpi .s{font-size:12px;color:rgba(234,255,241,.78);margin-top:4px}

    .list{margin-top:10px;border:1px solid rgba(255,255,255,.14);border-radius:16px;overflow:hidden}
    .item{
      padding:12px;border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .item:first-child{border-top:none}
    .a{font-weight:1000}
    .b{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35}
    .badge{
      font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(250,204,21,.10);
      white-space:nowrap;
    }
    .badge.ok{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35)}
    .badge.bad{background:rgba(251,113,133,.12); border-color:rgba(251,113,133,.35)}
    .badge.neutral{background:rgba(148,163,184,.10); border-color:rgba(148,163,184,.28)}
    .muted{color:var(--muted)}

    .modal{
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.55);
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modal .box{
      width:min(640px,94vw);
      background:linear-gradient(145deg,rgba(11,42,31,.98),rgba(6,35,25,.98));
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:16px;
      box-shadow:0 24px 60px rgba(0,0,0,.65);
    }
    .fgrid{display:grid;gap:10px;margin-top:10px}
    @media(min-width:680px){ .fgrid{grid-template-columns:1fr 1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    input, select, textarea{
      width:100%;
      border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18); color:var(--text);
      padding:12px 12px; outline:none;
      font-weight:800;
    }
    textarea{min-height:90px;resize:vertical;font-weight:700}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .actions button{
      flex:1; min-width:190px;
      padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.16);
      background:rgba(250,204,21,.12);
      color:var(--text);font-weight:1000;cursor:pointer;
    }
    .actions button:hover{border-color:rgba(250,204,21,.55)}
    .actions .primary{
      background:linear-gradient(90deg,var(--ok),var(--gold));
      color:#062015;border:none;
    }
    .close{
      margin-top:10px;
      width:100%;
      padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);
      color:var(--text);font-weight:1000;cursor:pointer;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.45}
    .tiny{font-size:11px;color:rgba(234,255,241,.66)}
    .split{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .split .btn{min-width:170px}
  </style>
</head>

<body>
<div class="wrap">

  <!-- TOP BAR -->
  <div class="top">
    <div class="brand">
      <div class="ico">ü¶Ö</div>
      <div>
        <h1>üì¶ FRET CLIENT PRO ‚Äî Cockpit</h1>
        <div class="sub">
          SLUG: <b id="slug">‚Äî</b> ‚Ä¢ OWNER: <b id="owner">‚Äî</b><br>
          Statut: <b class="muted" id="stat">session OK</b>
        </div>
      </div>
    </div>
    <div class="pill">fret_client_pro</div>
  </div>

  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <div class="title">‚ö° ACTIONS RAPIDES</div>
      <div class="row">
        <button class="btn primary" id="btnNew">‚ûï Nouvelle exp√©dition</button>
        <button class="btn" id="btnToday">üìç Aujourd‚Äôhui</button>
        <button class="btn" id="btnPulse">üîî Inbox</button>
      </div>

      <div style="height:10px"></div>
      <div class="title">üå°Ô∏è TEMP√âRATURE BUSINESS</div>
      <div class="kpis">
        <div class="kpi">
          <div class="k">Aujourd‚Äôhui</div>
          <div class="v" id="kToday">‚Äî</div>
          <div class="s">demandes</div>
        </div>
        <div class="kpi">
          <div class="k">En attente</div>
          <div class="v" id="kPending">‚Äî</div>
          <div class="s">√† confirmer</div>
        </div>
        <div class="kpi">
          <div class="k">Accept√©es</div>
          <div class="v" id="kAccepted">‚Äî</div>
          <div class="s">en cours</div>
        </div>
        <div class="kpi">
          <div class="k">Livr√©es</div>
          <div class="v" id="kDone">‚Äî</div>
          <div class="s">termin√©es</div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="split">
        <div class="title" style="flex:1">üìã DEMANDES D‚ÄôEXP√âDITION</div>
        <select id="filter" style="max-width:240px">
          <option value="all">Toutes</option>
          <option value="pending">En attente</option>
          <option value="accepted">Accept√©es</option>
          <option value="delivered">Livr√©es</option>
          <option value="cancelled">Annul√©es</option>
        </select>
      </div>

      <div class="list" id="list"></div>

      <div class="hint">
        <b>V1 Terrain :</b> stockage local par slug (√ßa marche instant).<br>
        <span class="tiny">V2 : on branche Supabase (RPC CRUD s√©curis√©) et Pulse Inbox.</span>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="title">üîî INBOX (placeholder)</div>
      <div class="list" id="inbox">
        <div class="item">
          <div>
            <div class="a">Aucun message</div>
            <div class="b">On branchera Pulse/outbox apr√®s. L√† tu as d√©j√† le cockpit √©quip√©.</div>
          </div>
          <div class="badge neutral">OK</div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="title">üõü SUPPORT</div>
      <div class="row">
        <button class="btn" id="btnHelp">üí¨ WhatsApp Support</button>
        <button class="btn" id="btnLogout">üö™ D√©connexion</button>
      </div>

      <div style="height:12px"></div>
      <div class="title">üß© COMMANDES RAPIDES</div>
      <div class="row">
        <button class="btn" id="btnExport">‚¨áÔ∏è Export JSON</button>
        <button class="btn" id="btnReset">üßπ Reset D√©mo</button>
      </div>
    </div>

  </div>
</div>

<!-- MODAL NEW -->
<div class="modal" id="modalNew" aria-hidden="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <div style="font-weight:1000">‚ûï Nouvelle exp√©dition</div>
      <div class="badge neutral" id="mSlug">‚Äî</div>
    </div>

    <div class="fgrid">
      <div>
        <label>D√©part</label>
        <input id="from" placeholder="Ex: Saly / Dakar / Thi√®s">
      </div>
      <div>
        <label>Arriv√©e</label>
        <input id="to" placeholder="Ex: Dakar / Mbour / Saint-Louis">
      </div>
      <div>
        <label>Nom client</label>
        <input id="client" placeholder="Ex: Astou">
      </div>
      <div>
        <label>T√©l√©phone client</label>
        <input id="phone" placeholder="+221‚Ä¶">
      </div>
      <div>
        <label>Type</label>
        <select id="type">
          <option value="colis">Colis</option>
          <option value="document">Document</option>
          <option value="marchandise">Marchandise</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div>
        <label>Prix propos√© (FCFA)</label>
        <input id="price" inputmode="numeric" placeholder="Ex: 3000">
      </div>
    </div>

    <div style="margin-top:6px">
      <label>D√©tails</label>
      <textarea id="details" placeholder="Ex: fragile, petit sac, remettre √† la main‚Ä¶"></textarea>
    </div>

    <div class="actions">
      <button class="primary" id="save">‚úÖ Enregistrer</button>
      <button id="cancel">Annuler</button>
    </div>

    <button class="close" id="close">Fermer</button>
  </div>
</div>

<script>
  // session universelle pos√©e par pin.html
  const s = window.DIGIY_ACCESS || {};
  const slug = (s.slug || "").toLowerCase();

  document.getElementById("slug").textContent = s.slug || "‚Äî";
  document.getElementById("owner").textContent = s.owner_id || "‚Äî";

  // storage key par slug
  const KEY = "DIGIY_FRET_CLIENT_JOBS::" + (slug || "noslug");

  function nowISO(){ return new Date().toISOString(); }
  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function uid(){
    return (crypto?.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)+Date.now()));
  }

  function load(){
    try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch(_){ return []; }
  }
  function save(rows){
    localStorage.setItem(KEY, JSON.stringify(rows));
  }

  function statusBadge(st){
    if(st==="pending") return `<span class="badge neutral">EN ATTENTE</span>`;
    if(st==="accepted") return `<span class="badge ok">ACCEPT√â</span>`;
    if(st==="delivered") return `<span class="badge ok">LIVR√â</span>`;
    if(st==="cancelled") return `<span class="badge bad">ANNUL√â</span>`;
    return `<span class="badge neutral">${String(st||"‚Äî").toUpperCase()}</span>`;
  }

  function fmtMoney(v){
    const n = Number(String(v||"").replace(/[^\d]/g,"")) || 0;
    return n ? (n.toLocaleString("fr-FR") + " FCFA") : "‚Äî";
  }

  function render(){
    const rows = load().sort((a,b)=> (b.created_at||"").localeCompare(a.created_at||""));
    const filter = document.getElementById("filter").value;

    const tk = todayKey();
    const today = rows.filter(r => (r.day_key === tk));
    const pending = rows.filter(r => r.status==="pending");
    const accepted = rows.filter(r => r.status==="accepted");
    const done = rows.filter(r => r.status==="delivered");

    document.getElementById("kToday").textContent = String(today.length);
    document.getElementById("kPending").textContent = String(pending.length);
    document.getElementById("kAccepted").textContent = String(accepted.length);
    document.getElementById("kDone").textContent = String(done.length);

    let view = rows;
    if(filter !== "all") view = rows.filter(r => r.status === filter);

    const list = document.getElementById("list");
    list.innerHTML = "";

    if(view.length === 0){
      list.innerHTML = `
        <div class="item">
          <div>
            <div class="a">Aucune demande</div>
            <div class="b">Clique ‚ÄúNouvelle exp√©dition‚Äù pour cr√©er ta premi√®re.</div>
          </div>
          <div class="badge neutral">VIDE</div>
        </div>`;
      return;
    }

    for(const r of view){
      const title = `${r.from || "‚Äî"} ‚Üí ${r.to || "‚Äî"}`;
      const sub = [
        `Client: ${r.client || "‚Äî"} (${r.phone || "‚Äî"})`,
        `Type: ${r.type || "‚Äî"} ‚Ä¢ Prix: ${fmtMoney(r.price)}`,
        r.details ? `Note: ${r.details}` : null,
        `Cr√©√©: ${new Date(r.created_at).toLocaleString("fr-FR")}`
      ].filter(Boolean).join("<br>");

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div style="flex:1">
          <div class="a">${title}</div>
          <div class="b">${sub}</div>
          <div class="row" style="margin-top:10px">
            <button class="btn" data-act="accept" data-id="${r.id}">‚úÖ Accepter</button>
            <button class="btn" data-act="deliver" data-id="${r.id}">üì¶ Livrer</button>
            <button class="btn" data-act="cancel" data-id="${r.id}">üß® Annuler</button>
            <button class="btn" data-act="del" data-id="${r.id}">üóëÔ∏è Supprimer</button>
          </div>
        </div>
        <div>${statusBadge(r.status)}</div>
      `;
      list.appendChild(item);
    }
  }

  function update(id, patch){
    const rows = load();
    const i = rows.findIndex(x=>x.id===id);
    if(i<0) return;
    rows[i] = { ...rows[i], ...patch };
    save(rows);
    render();
  }

  function remove(id){
    const rows = load().filter(x=>x.id!==id);
    save(rows);
    render();
  }

  // modal
  const modal = document.getElementById("modalNew");
  const openModal = ()=>{
    document.getElementById("mSlug").textContent = slug || "‚Äî";
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden","false");
    setTimeout(()=>document.getElementById("from").focus(), 150);
  };
  const closeModal = ()=>{
    modal.style.display = "none";
    modal.setAttribute("aria-hidden","true");
  };

  document.getElementById("btnNew").onclick = openModal;
  document.getElementById("cancel").onclick = closeModal;
  document.getElementById("close").onclick = closeModal;
  modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });

  document.getElementById("save").onclick = ()=>{
    const job = {
      id: uid(),
      owner_id: s.owner_id || null,
      slug: slug || null,
      status: "pending",
      day_key: todayKey(),
      from: document.getElementById("from").value.trim(),
      to: document.getElementById("to").value.trim(),
      client: document.getElementById("client").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      type: document.getElementById("type").value,
      price: document.getElementById("price").value.trim(),
      details: document.getElementById("details").value.trim(),
      created_at: nowISO()
    };

    const rows = load();
    rows.unshift(job);
    save(rows);

    // reset form
    ["from","to","client","phone","price","details"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("type").value = "colis";

    closeModal();
    render();
  };

  // list actions (delegation)
  document.addEventListener("click",(e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const id = b.getAttribute("data-id");
    const act = b.getAttribute("data-act");

    if(act==="accept") return update(id, { status:"accepted", updated_at: nowISO() });
    if(act==="deliver") return update(id, { status:"delivered", updated_at: nowISO() });
    if(act==="cancel") return update(id, { status:"cancelled", updated_at: nowISO() });
    if(act==="del") return remove(id);
  });

  document.getElementById("filter").onchange = render;

  // Quick buttons
  document.getElementById("btnToday").onclick = ()=>{
    document.getElementById("filter").value = "all";
    render();
    alert("üìç Astuce: la KPI ‚ÄòAujourd‚Äôhui‚Äô compte les demandes du jour. (V2: filtre date avanc√©)");
  };
  document.getElementById("btnPulse").onclick = ()=>alert("üîî Inbox: V2 on branche Pulse/outbox.");

  // Support WhatsApp
  document.getElementById("btnHelp").onclick = ()=>{
    const num = "+221771342889";
    const txt = encodeURIComponent("DIGIY Support ‚Äî FRET CLIENT PRO. Slug: " + (slug||"") + " ‚Ä¢ Besoin d‚Äôaide.");
    location.href = "https://wa.me/" + num.replace("+","") + "?text=" + txt;
  };

  // Logout
  document.getElementById("btnLogout").onclick = ()=>{
    localStorage.removeItem("DIGIY_ACCESS");
    location.href = "./pin.html" + (slug ? ("?slug="+encodeURIComponent(slug)) : "");
  };

  // Export / Reset
  document.getElementById("btnExport").onclick = ()=>{
    const rows = load();
    const blob = new Blob([JSON.stringify(rows,null,2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "fret-client-" + (slug||"pro") + ".json";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 800);
  };

  document.getElementById("btnReset").onclick = ()=>{
    if(confirm("Reset d√©mo pour ce slug ?")){
      localStorage.removeItem(KEY);
      render();
    }
  };

  // init
  if(!slug){
    document.getElementById("stat").textContent = "slug manquant (retour pin)";
  }
  render();
</script>
</body>
</html>
